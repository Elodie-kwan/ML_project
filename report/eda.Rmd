---
output:
  html_document: default
  pdf_document: default
---
```{r, echo = FALSE, message = FALSE, warning = FALSE}
source(here::here("scripts/setup.R"))
```

### part 2 : Exploratory Data Analysis 
<br />
<br />
This section is dedicated to understanding the data. We will provide an analysis of the data set using a visual approach in order to summarize their main characteristics.
<br />
<br />
Let's import the cleaned dataset that we created. 

```{r}
Mountain_data_cleaned <- read.csv("../data/Mountain_data_cleaned.csv")
```
<br />

```{r, echo = FALSE, message = FALSE, warning = FALSE}
Mountain_data_cleaned$Country <- as.factor(Mountain_data_cleaned$Country)
Mountain_data_cleaned$Mountain_range <- as.factor(Mountain_data_cleaned$Mountain_range)
Mountain_data_cleaned$Locality <- as.factor(Mountain_data_cleaned$Locality)
Mountain_data_cleaned$Plot <- as.factor(Mountain_data_cleaned$Plot)
Mountain_data_cleaned$Subplot <- as.factor(Mountain_data_cleaned$Subplot)
```
We will analyze some basic statistical elements for each variable. To do this we need to transform the variable **Date** to date format.  
```{r}
Mountain_data_cleaned$Date <- as.Date(Mountain_data_cleaned$Date)
```
<br />
We first look at the general aspect of the data set and try to discover if there are any missing values. 
<br />
```{r echo=F,results='asis',error=F,warning=F}

library('knitr')######3

kable(introduce(Mountain_data_cleaned)[,-c(3:4,9 )], format = "markdown")
```
<br />
There are 2 missing values in the feature **Glu_P**. One is at the instance number 377 and the other one is at the instance 378. 
<br />
```{r echo=F,results='asis',error=F,warning=F}

kable(head(Mountain_data_cleaned[c(which(is.na(Mountain_data_cleaned$Glu_P))),c(1:6, 12)]), format = "markdown")
```

```{r, echo = FALSE, message = FALSE, warning = FALSE}
#dfSummary(Mountain_data_cleaned, style="grid")
```
<br />
To understand the distribution of our data in the data set we use the following graph: 
<br />
<br />
```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width=9,fig.height=3, out.width = "100%"}
plot_intro(Mountain_data_cleaned)
```
<br />
All the variables that we will train for our models come from columns composed of continuous values, which explains their predominance. We can also notice that the share of missing observations represents only 0.014% of the total number of observations. Which at first sight makes it a good data set.
<br />
<br />
We take our search for anomalies further by exploring the characteristics of each variable.For the readability of the report, we show only a few variables.
```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "70%"}
x<- describe(Mountain_data_cleaned)
x$Country
x$Mountain_range
x$Phos_P
x$Glu_P
x$NT_P
```
We can observe that there is a big difference between the total number of observations and the number of distinct observations for the variables related to the chemical elements. We will try to understand where this difference comes from in the visual analysis part. 
<br />
<br />
<br />

## Data visualization : Plotting the data

<br />
<br />
We plot the numerical variables. 

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "50%"}
# plot_histogram(Mountain_data_cleaned)
plot_density(Mountain_data_cleaned)
```
<br />
Many variables appear with a distribution that looks like the log-normal distribution.

+ The variables **pH_B** and **pH_T** are not normally distributed. 
+ Most of the variables are right-tailed. 
<br />
<br />
We will then use box-plots to detect outliers on numerical variable and compare the distributions to each mountain class.
<br />
```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "50%"}
plot_boxplot(Mountain_data_cleaned, by = 'Mountain_range',  ncol = 2, title = "Side-by-side boxplots", geom_boxplot_args = list("outlier.color" = "red"))


```
<br />
We can see the real differences between the mountains. 

+ Generally speaking, it seems that the mountain "Sierra de Guadarrama" has a higher value of **Glu_P**, **Phos_P**, **SOC_P**, **Glu_B**, **Phos_B**, **SOC_B**, **Glu_T**, **Phos_T** and **SOC_T**.
+ There are a lot of outliers in almost all the features. 
<br />
<br />
We plot the categorical variables: 
<br />

```{r, echo = FALSE, message = FALSE, warning = FALSE, fig.width=9,fig.height=10, out.width = "70%"}
a <- ggplot(Mountain_data_cleaned) +
  geom_bar(mapping = aes(x = Country, fill= Mountain_range)) +
  coord_flip() + theme(legend.position = "none")
b <- ggplot(Mountain_data_cleaned) +
  geom_bar(aes(x = Locality, fill= Mountain_range)) +
  coord_flip()

a+b
```

<br />
We see that more observations come from Spain, which is normal since two out of three mountains are located in Spain. The localities where the samples were taken are almost all composed of a sample of 5 subsamples. Some localities, perhaps more interesting for the study, were sampled several times, but always by a multiple of 5 subsamples. 
<br />
```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "50%"}
ggplot(Mountain_data_cleaned) +
  geom_bar(aes(x = Mountain_range, fill= Mountain_range))
```
<br />
We have more observations about the mountain "Sierra de Guadarrama" (195) compared to "Central Andes" (100) and "Central Pyrenees" (135). As the differences between the number of observation is big enough for us to be careful on the results and consider to balance the data if it is needed. 
<br />
Can comment on the number of different observations and the effect on accuracy. **Can focus more on sensibility and sensitivy** if needed because indeed there is twice more informations on Sierra de Guadarrama.
<br />
As described above with the summary output of the data, we see that we have more information on the mountain "Sierra de Guadarrama". There is twice more information compared to the mountain "Central Andes". Our final result might be affected on a bad way because the model will tend to produce a good accuracy (so having a tendency to predict "Sierra de Guadarrama" more often) but it will not be good enough to predict a new instance. 
<br />
We will have to see if we will need to balance our data to get a better model. 
<br />
We will also inspect the possible duplicate observations, indeed as previously found, some variables do not have the whole of their observations which are distinct.
<br />

```{r, echo = FALSE, message = FALSE, warning = FALSE, out.width = "50%"}
Mountain_data_cleaned_uni <- Mountain_data_cleaned[, -5] %>% unique()
ggplot(Mountain_data_cleaned_uni) +
  geom_bar(aes(x = Mountain_range, fill= Mountain_range))

```
<br />
We notice immediately the poverty of the data concerning the samples of **Sierra de Guadarrama**, this function leaves us with a data set of only 274 observations. We will therefore try a first time to implement our models by keeping the duplicates, knowing that identical values in the train set and the test set will influence the measured accuracy of the model. Then we will test again our models with the reduced data set to observe if there is a loss of accuracy. 
<br />

Correlation plot between continuous variables : 
```{r}
plot_correlation(Mountain_data_cleaned, type= 'c', cor_args = list( 'use' = 'complete.obs'))
```

From the correlation plot it seems that some pattern can be observed. The variables concerning the **Phosphatase enzyme** seems to be positively correlated with the variable about **Soil organic carbon**. 

```{r}
Mountain_data_cleaned %>%
  select(Phos_P, Phos_B, Phos_T, SOC_P, SOC_B, SOC_T) %>%
  ggpairs()
```


Make a regression Mountain_range ~ ... to see the relevant variables 
+
Make a PCA


## Principal Component Analysis (PCA) exploration

- Select only the numerical values:

```{r}
Mountain_data.num <- select_if(Mountain_data_cleaned, is.numeric)
to.delet <- c('Day', 'Month', 'Year')
Mountain_data.num <- select(Mountain_data.num, -to.delet)

```


```{r}
Mountain_data.pca <- prcomp(na.omit(Mountain_data.num), center = TRUE, scale = TRUE)
summary(Mountain_data.pca)
```


Here, as the command _prcomp_ do not allow NAs in the data. We use the command _na.omit_ on our reduced data containing the numerical values to omit all NAs cases from the data frame.


```{r}
resultats_pca <- PCA(Mountain_data.num, scale.unit = TRUE, ncp = 5, graph = FALSE)
resultats_pca
```

```{r}
eig.val <- get_eigenvalue(resultats_pca)
eig.val
```

```{r}
fviz_eig(resultats_pca, addlabels = TRUE)
```

```{r}
fviz_pca_var(resultats_pca)
```

```{r}
var <- get_pca_var(resultats_pca)
var
```

```{r}
corrplot(var$cos2, is.corr = FALSE)
```

```{r}
fviz_pca_ind(resultats_pca)
```


```{r}
fviz_pca_biplot(resultats_pca, repel = TRUE,
                col.var = "blue", # Couleur des variables
                col.ind = "red"  # Couleur des individues
                )
```


